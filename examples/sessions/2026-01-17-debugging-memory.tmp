# セッション: メモリリーク調査
**日付:** 2026-01-17
**開始:** 09:00
**最終更新:** 12:00

---

## 現在の状況

本番のメモリリークを調査中。24h の間にヒープが無制限に増加している。

### 完了
- [x] ステージングでヒープスナップショットを設定
- [x] リーク源を特定: イベントリスナーがクリーンアップされていない
- [x] WebSocket ハンドラーのリークを修正
- [x] 4h のソークテストで修正を確認

### 根本原因
WebSocket の `onMessage` ハンドラーが再接続時に追加されるが、切断時に削除されていなかった。約 1000 回の再接続の後、メモリが 200MB から 2GB に増加した。

### 修正
```javascript
// 変更前（リーク）
socket.on('connect', () => {
  socket.on('message', handleMessage)
})

// 変更後（修正済み）
socket.on('connect', () => {
  socket.off('message', handleMessage) // 先に古いリスナーを外す
  socket.on('message', handleMessage)
})

// さらに良い: once を使うか disconnect でクリーンアップする
socket.on('disconnect', () => {
  socket.removeAllListeners('message')
})
```

### 残すべきデバッグ手法
1. T=0 でヒープスナップショットを取る
2. 強制 GC: `global.gc()`
3. 疑わしい操作を N 回実行する
4. T=1 でヒープスナップショットを取る
5. スナップショットを比較し、count = N のオブジェクトを探す

### 次セッションのメモ
- 1GB 閾値でメモリ監視アラートを追加する
- このデバッグパターンをチーム向けに文書化する

### 読み込むコンテキスト
```
src/services/websocket.js
```
